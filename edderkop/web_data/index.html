<!DOCTYPE html>
<meta charset="utf-8">
<style>

.links line {
  stroke: #999;
  stroke-opacity: 0.6;
}

.nodes circle {
  stroke: #fff;
  stroke-width: 1.5px;
}

.nodes rect {
  fill: #fff;
  stroke: #444;
  stroke-width: 1.5px;
}
</style>
<svg width="900" height="600"></svg>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script>

var offset = 5;
var imgsize = 30;


var links = [];
var nodes = [];

var svg = d3.select("svg"),
    width = +svg.attr("width"),
    height = +svg.attr("height");

var simulation = d3.forceSimulation()
    .force("link", d3.forceLink().id(function(d) { return d.id; }))
    .force("charge", d3.forceManyBody())
    .force("collision", d3.forceCollide(function(d) { return 150; bbox = d.getBBox(); console.log('again'); return (Math.max(bbox.width, bbox.height)+20)/2; }))
    .force("center", d3.forceCenter(width / 2, height / 2));

svg.append("g").attr("class", "links");
svg.append("g").attr("class", "nodes");

function update() {

  var link = svg.select("g.links")
      .selectAll("line")
      .data(links)
      .enter().append("line")
      .attr("stroke-width", 2);

  console.log(link);
  var node = svg.select("g.nodes")
      .selectAll('g.node')
      .data(nodes) //, function (d) { debugger; return d.id; })
      .enter().append("g").attr("class", "node");
  console.log(node);

  node.append("rect");
  node.append("text").text(function(d) { d.textNode = this; d.getBBox = function(){ return this.textNode.getBBox(); }; return d.id });
  node.append("svg:image")
      .attr("xlink:href", function(d) { return d.img ? d.id : null})
      .attr("height", "30px")
      .attr("width", "30px");
    
  node.call(d3.drag()
              .on("start", function (d) {
                             if (!d3.event.active) simulation.alphaTarget(0.3).restart();
                             d.fx = d.x;
                             d.fy = d.y;
                           })
              .on("drag", function (d) {
                            d.fx = d3.event.x;
                            d.fy = d3.event.y;
                          })
              .on("end", function (d) {
                           if (!d3.event.active) simulation.alphaTarget(0);
                           d.fx = null;
                           d.fy = null;
                         }));

  function ticked() {
    svg.select("g.links")
       .selectAll("line")
        .attr("x1", function(d) { return d.source.x; })
        .attr("y1", function(d) { return d.source.y; })
        .attr("x2", function(d) { return d.target.x; })
        .attr("y2", function(d) { return d.target.y; });

    nodeset = svg.select("g.nodes").selectAll("g.node");

    nodeset.select("text")
           .attr("x", function(d) { return d.x; })
           .attr("y", function(d) { return d.y; });

    nodeset.select("rect")
           .attr("x", function(d) { return d.getBBox().x-offset; })
           .attr("y", function(d) {
                        bbox = d.getBBox();
                        mid_y = bbox.height/2 + bbox.y;
                        return mid_y - Math.max(bbox.height, imgsize)/2 - offset; })
           .attr("height", function(d) { return Math.max(d.getBBox().height, imgsize) + 2*offset; })
           .attr("width", function(d) { return d.getBBox().width + (d.img ?  (3*offset + imgsize) : (2*offset)); });

    nodeset.select("image")
           .attr("x", function(d) { return d.x + d.getBBox().width + offset; })
           .attr("y", function(d) {
                        bbox = d.getBBox();
                        mid_y = bbox.height/2 + bbox.y;
                        return mid_y - Math.max(bbox.height, imgsize)/2; });
  }

  simulation.nodes(nodes)
            .on("tick", ticked);

  simulation.force("link")
            .links(links);
}

function addImage(url) {
  addNode({id: url, img: true});
}

function addPage(url) {
  addNode({id: url, img: false});
}

function addNode(node) {
  nodes.push(node);
  update();
}

function addLink(link) {
  links.push(link);
  update();
}

</script>
